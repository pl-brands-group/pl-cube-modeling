cubes:
  - name: shopify_orders_aggby_spu
    title: Shopify订单按SPU国家聚合表
    description: Shopify订单按SPU,国家,日期聚合的数据表，包含订单指标、广告投放指标、转化指标等，支持按日期、国家代码、SPU维度分析
    sql_table: shopify_transform.ads_created_orders_aggby_spu
    data_source: default

    joins: []

    dimensions:
      - name: date
        title: 订单创建日期
        description: 订单日期
        sql: "CAST({CUBE}.date AS TIMESTAMP)"
        type: time
        primary_key: true

      - name: country_code
        title: 国家代码
        description: 国家代码
        sql: country_code
        type: string
        primary_key: true

      - name: spu_id
        title: SPU
        description: 标准产品单元标识符
        sql: spu_id
        type: string
        primary_key: true

      - name: is_ai_product
        title: 是否测款
        description: 是否为测试款（Y/N）
        sql: is_ai_product
        type: string

    measures:
      - name: count
        title: 计数
        description: 订单记录总数
        type: count

      - name: item_quantity_by_spu
        title: 销量
        description: 按SPU聚合的商品数量总和
        sql: item_quantity_by_spu
        type: sum

      - name: line_item_gross_amount_usd_by_spu
        title: 商品总金额（美元）
        description: 商品总金额（美元）
        sql: line_item_gross_amount_usd_by_spu
        type: sum

      - name: line_item_discount_usd_by_spu
        title: 折扣金额（美元）
        description: 折扣金额（美元）
        sql: line_item_discount_usd_by_spu
        type: sum

      - name: line_item_tax_amount_usd_by_spu
        title: 税费金额（美元）
        description: 税费金额（美元）
        sql: line_item_tax_amount_usd_by_spu
        type: sum

      - name: line_item_shipping_amount_usd_by_spu
        title: 运费金额（美元）
        description: 运费金额（美元）
        sql: line_item_shipping_amount_usd_by_spu
        type: sum

      - name: line_item_gmv_usd_by_spu
        title: GMV
        description: 商品交易总额
        sql: line_item_gmv_usd_by_spu
        type: sum

      - name: split_target_fb_spend_by_spu
        title: 分摊目标FB花费
        description: 分摊目标Facebook广告花费
        sql: split_target_fb_spend_by_spu
        type: sum

      - name: unsplit_target_fb_spend_by_spu
        title: 未分摊目标FB花费
        description: 未分摊目标Facebook广告花费
        sql: unsplit_target_fb_spend_by_spu
        type: sum

      - name: split_target_fb_roas_by_spu
        title: 分摊目标FB ROAS
        description: 分摊目标Facebook广告投资回报率
        sql: split_target_fb_roas_by_spu
        type: sum

      - name: unsplit_target_fb_roas_by_spu
        title: 未分摊目标FB ROAS
        description: 未分摊目标Facebook广告投资回报率
        sql: unsplit_target_fb_roas_by_spu
        type: sum

      - name: fb_spend_usd_by_spu
        title: 未分摊FB广告花费
        description: 未分摊Facebook广告花费（美元）
        sql: fb_spend_usd_by_spu
        type: sum

      - name: fb_impressions_by_spu
        title: 未分摊FB曝光数
        description: 未分摊Facebook广告展示次数
        sql: fb_impressions_by_spu
        type: sum

      - name: fb_inline_link_clicks_by_spu
        title: 未分摊FB链接点击数
        description: 未分摊Facebook广告内联链接点击数
        sql: fb_inline_link_clicks_by_spu
        type: sum

      - name: fb_view_content_by_spu
        title: 未分摊FB查看内容数
        description: 未分摊Facebook广告查看内容事件数
        sql: fb_view_content_by_spu
        type: sum

      - name: fb_add_to_cart_by_spu
        title: 未分摊FB加购数
        description: 未分摊Facebook广告加购事件数
        sql: fb_add_to_cart_by_spu
        type: sum

      - name: fb_purchase_by_spu
        title: 未分摊FB订单数
        description: 未分摊Facebook广告购买事件数
        sql: fb_purchase_by_spu
        type: sum

      - name: fb_purchase_gmv_by_spu
        title: 未分摊FB_GMV
        description: 未分摊Facebook广告购买GMV
        sql: fb_purchase_gmv_by_spu
        type: sum

      - name: google_spend_usd_by_spu
        title: 未分摊Google广告花费
        description: Google广告花费
        sql: google_spend_usd_by_spu
        type: sum

      - name: google_metrics_impressions_by_spu
        title: 未分摊Google展示次数
        description: Google广告展示次数
        sql: google_metrics_impressions_by_spu
        type: sum

      - name: google_metrics_clicks_by_spu
        title: 未分摊Google点击数
        description: Google广告点击数
        sql: google_metrics_clicks_by_spu
        type: sum

      - name: split_fb_spend_usd_by_spu
        title: 分摊FB广告花费
        description: 分摊Facebook广告花费
        sql: split_fb_spend_usd_by_spu
        type: sum

      - name: split_fb_impressions_by_spu
        title: 分摊FB展示次数
        description: 分摊Facebook广告展示次数
        sql: split_fb_impressions_by_spu
        type: sum

      - name: split_fb_inline_link_clicks_by_spu
        title: 分摊FB链接点击数
        description: 分摊Facebook广告内联链接点击数
        sql: split_fb_inline_link_clicks_by_spu
        type: sum

      - name: split_fb_view_content_by_spu
        title: 分摊FB查看内容数
        description: 分摊Facebook广告查看内容事件数
        sql: split_fb_view_content_by_spu
        type: sum

      - name: split_fb_add_to_cart_by_spu
        title: 分摊FB加购数
        description: 分摊Facebook广告加购事件数
        sql: split_fb_add_to_cart_by_spu
        type: sum

      - name: split_fb_purchase_by_spu
        title: 分摊FB订单数
        description: 分摊Facebook广告购买事件数
        sql: split_fb_purchase_by_spu
        type: sum

      - name: split_fb_purchase_gmv_by_spu
        title: 分摊FBGMV
        description: 分摊Facebook广告购买GMV
        sql: split_fb_purchase_gmv_by_spu
        type: sum

      - name: split_google_spend_usd_by_spu
        title: 分摊Google广告花费
        description: 分摊Google广告花费
        sql: split_google_spend_usd_by_spu
        type: sum

      - name: split_google_metrics_impressions_by_spu
        title: 分摊Google展示次数
        description: 分摊Google广告展示次数
        sql: split_google_metrics_impressions_by_spu
        type: sum

      - name: split_google_metrics_clicks_by_spu
        title: 分摊Google点击数
        description: 分摊Google广告点击数
        sql: split_google_metrics_clicks_by_spu
        type: sum

      - name: itemsviewed
        title: 商品浏览数
        description: 商品浏览数量
        sql: "{CUBE}.`itemsViewed`"
        type: sum

      - name: itemsaddedtocart
        title: 商品加购数
        description: 商品加购数量
        sql: "{CUBE}.`itemsAddedToCart`"
        type: sum

      - name: itemspurchased
        title: 商品购买数
        description: 商品购买数量
        sql: "{CUBE}.`itemsPurchased`"
        type: sum

      - name: itemscheckedout
        title: 商品结账数
        description: 商品结账数量
        sql: "{CUBE}.`itemsCheckedOut`"
        type: sum

      - name: itemrevenue
        title: 商品收入
        description: 商品收入金额
        sql: "{CUBE}.`itemRevenue`"
        type: sum

      # ========== 自定义计算字段 ==========
      
      # 1. AI产品销量
      - name: test_item_quantity_by_spu
        title: 测试_销量
        sql: "CASE WHEN {CUBE}.is_ai_product = 'Y' THEN {CUBE}.item_quantity_by_spu ELSE 0 END"
        type: sum
        description: "测试_销量: 测款销量总和"
      
      # 2. AI产品的广告花费（用于计算test_cpc）
      - name: ai_fb_spend
        title: 测款FB广告花费
        sql: "CASE WHEN {CUBE}.is_ai_product = 'Y' THEN {CUBE}.fb_spend_usd_by_spu ELSE 0 END"
        type: sum
        description: "测款FB广告花费"
      
      # 3. AI产品的点击数（用于计算test_cpc）
      - name: ai_fb_clicks
        title: 测款FB点击数
        sql: "CASE WHEN {CUBE}.is_ai_product = 'Y' THEN {CUBE}.fb_inline_link_clicks_by_spu ELSE 0 END"
        type: sum
        description: "测款的FB点击数"
      
      # 4. AI产品的CPC
      - name: test_cpc
        title: 测款_CPC
        sql: "{ai_fb_spend} / NULLIF({ai_fb_clicks}, 0)"
        type: number
        description: "测试_CPC: AI商品的 CPC = AI花费 / AI点击"
      
      # 5. 近30天非AI产品的广告花费
      - name: non_ai_fb_spend_30d
        title: 近30天非测款FB广告花费
        sql: "CASE WHEN {CUBE}.is_ai_product = 'N' AND {CUBE}.date >= DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY) THEN {CUBE}.fb_spend_usd_by_spu ELSE 0 END"
        type: sum
        description: "近30天非AI产品的FB广告花费"
      
      # 6. 近30天非AI产品的点击数
      - name: non_ai_fb_clicks_30d
        title: 近30天非测款FB点击数
        sql: "CASE WHEN {CUBE}.is_ai_product = 'N' AND {CUBE}.date >= DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY) THEN {CUBE}.fb_inline_link_clicks_by_spu ELSE 0 END"
        type: sum
        description: "近30天非测款产品的FB点击数"
      
      # 7. 近30天CPC
      - name: cpc_30days
        title: 近30天非测款CPC
        sql: "{non_ai_fb_spend_30d} / NULLIF({non_ai_fb_clicks_30d}, 0)"
        type: number
        description: "近30天CPC: 非AI产品过去30天的CPC"
      
      # 8. 非AI产品的GMV（用于计算目标ROI）
      - name: non_ai_gmv
        title: 非测款GMV
        sql: "CASE WHEN {CUBE}.is_ai_product = 'N' THEN {CUBE}.line_item_gmv_usd_by_spu ELSE 0 END"
        type: sum
        description: "非测款的GMV"
      
      # 9. 非AI产品的目标广告花费（用于计算目标ROI）
      - name: non_ai_target_spend
        title: 非测款目标广告花费
        sql: "CASE WHEN {CUBE}.is_ai_product = 'N' THEN {CUBE}.split_target_fb_spend_by_spu ELSE 0 END"
        type: sum
        description: "非AI产品的目标广告花费"
      
      # 10. 目标ROI（重新定义的split_target_fb_roas）
      - name: target_roi
        title: 目标ROI
        sql: "CASE WHEN {non_ai_target_spend} = 0 THEN 3 ELSE {non_ai_gmv} / NULLIF({non_ai_target_spend}, 0) END"
        type: number
        description: "目标ROI: 非AI产品的GMV / 目标广告花费，当目标花费为0时返回3"
      
      # 11. ROI计算（GMV - Tax）/ 广告花费
      - name: roi
        title: ROI
        sql: "({line_item_gmv_usd_by_spu} - {line_item_tax_amount_usd_by_spu}) / NULLIF({split_fb_spend_usd_by_spu}, 0)"
        type: number
        description: "ROI: (GMV - 税费) / 广告花费"

    segments:
      - name: valid_spu
        title: 有效SPU
        sql: "{CUBE}.spu_id IS NOT NULL AND {CUBE}.spu_id <> ''"

      - name: non_ai_product
        title: 非测款
        sql: "{CUBE}.is_ai_product = 'N'"

      - name: has_activity
        title: 有活动记录
        description: 过滤出至少有一项活动指标（销量、GMV、税费、广告花费、点击数等）不为空的记录
        sql: |
          NOT (
            ({CUBE}.item_quantity_by_spu IS NULL OR {CUBE}.item_quantity_by_spu = 0)
            AND ({CUBE}.line_item_gmv_usd_by_spu IS NULL OR {CUBE}.line_item_gmv_usd_by_spu = 0)
            AND ({CUBE}.line_item_tax_amount_usd_by_spu IS NULL OR {CUBE}.line_item_tax_amount_usd_by_spu = 0)
            AND ({CUBE}.fb_spend_usd_by_spu IS NULL OR {CUBE}.fb_spend_usd_by_spu = 0)
            AND ({CUBE}.fb_inline_link_clicks_by_spu IS NULL OR {CUBE}.fb_inline_link_clicks_by_spu = 0)
            AND ({CUBE}.split_fb_spend_usd_by_spu IS NULL OR {CUBE}.split_fb_spend_usd_by_spu = 0)
            AND ({CUBE}.split_google_spend_usd_by_spu IS NULL OR {CUBE}.split_google_spend_usd_by_spu = 0)
          )
