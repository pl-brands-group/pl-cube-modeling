cubes:
  #聚水潭采购入库单
  - name: dwd_purchase_in_query_sku_clean
    sql: |
      SELECT 
        io.*,
        po.sum_price as po_sum_price,
        po.qty as po_qty,
        po.delivery_date as po_delivery_date
      FROM Jushuitan.dwd_purchaseInQuerySku_clean io
      LEFT JOIN Jushuitan.dwd_purchaseQuerySku_clean po
        ON io.po_id = po.po_id AND io.sku_id = po.sku_id
      WHERE
        io.type = '采购进仓'
        AND io.supplier_name != ''
        AND io.supplier_name != 'test'
        AND io.io_date > '2025-03-01'
        AND po.item_type = '成品'
        AND po.po_date > '2025-02-28'
        AND po.status IN ('Confirmed', 'Finished')
        AND po.labels NOT IN ('返修单', '返修退货', '代售')
        AND po.seller <> 'test'
    data_source: default

    joins:
      - name: dwd_purchase_query_sku_clean
        sql: "{CUBE}.po_id = {dwd_purchase_query_sku_clean}.po_id AND {CUBE}.sku_id = {dwd_purchase_query_sku_clean}.sku_id"
        relationship: many_to_one

    dimensions:
      - name: sku_id
        sql: sku_id
        type: string
        primary_key: true

      - name: po_id
        sql: po_id
        type: number
        primary_key: true

      - name: io_date
        sql: io_date
        type: time

    measures:
      - name: count
        type: count

      #入库数量
      - name: qty
        sql: qty
        type: sum
      
      

      # 延期天数（入库日期 - 协议到货日期），小于等于0时为0
      - name: delay_days
        sql: "GREATEST(0, DATE_DIFF(CAST({CUBE}.io_date AS DATE), CAST({CUBE}.po_delivery_date AS DATE), DAY))"
        type: sum

      # 已入库延期费用 = po单总金额 * 0.1 / 30 * (入库数量/订单数量) * 延期天数
      - name: received_delay_cost
        sql: |
          {CUBE}.po_sum_price * 0.1 / 30.0 * 
          ({CUBE}.qty / NULLIF({CUBE}.po_qty, 0)) * 
          GREATEST(0, DATE_DIFF(CAST({CUBE}.io_date AS DATE), CAST({CUBE}.po_delivery_date AS DATE), DAY))
        type: sum

    pre_aggregations:
      # Pre-aggregation definitions go here.
      # Learn more in the documentation: https://cube.dev/docs/caching/pre-aggregations/getting-started

