cubes:
  # 聚水潭采购订单SKU明细
  - name: dwd_purchase_query_sku_clean
    sql: |
      SELECT *
      FROM Jushuitan.dwd_purchaseQuerySku_clean
      WHERE
        item_type = '成品'
        AND po_date > '2025-02-28'
        AND status IN ('Confirmed', 'Finished')
        AND labels NOT IN ('返修单', '返修退货', '代售')
        AND seller <> 'test'
    data_source: default

    dimensions:
      - name: po_id
        sql: po_id
        type: number
        primary_key: true

      - name: sku_id
        sql: sku_id
        type: string
        primary_key: true

      - name: po_date
        sql: po_date
        type: time

      - name: status
        sql: status
        type: string

      - name: seller
        sql: seller
        type: string

      - name: finish_time
        sql: finish_time
        type: time

      - name: delivery_date
        sql: delivery_date
        type: time

    measures:
      - name: count
        type: count

      # 订单数量
      - name: qty
        sql: qty
        type: sum

      # 已入库数量
      - name: inqty
        sql: inqty
        type: sum

      # 单价
      - name: unit_price
        sql: unit_price
        type: avg

      # 金额
      - name: price
        sql: price
        type: sum

      # 采购单总金额
      - name: sum_price
        sql: sum_price
        type: sum

      # 利润额度
      - name: profit_limit
        sql: profit_limit
        type: sum

      # 未入库数量 = 订单数量 - 已入库数量
      - name: unreceived_qty
        sql: qty - inqty
        type: sum

      # 未入库延期天数（当前日期 - 协议到货日期），小于等于0时为0
      - name: unreceived_delay_days
        sql: "GREATEST(0, DATE_DIFF(CURRENT_DATE(), CAST({CUBE}.delivery_date AS DATE), DAY))"
        type: sum

      # 未入库延期费用 = po单总金额 * 0.1 / 30 * ((订单数量-已入库数量)/订单数量) * 延期天数
      - name: unreceived_delay_cost
        sql: |
          {CUBE}.sum_price * 0.1 / 30.0 * 
          (({CUBE}.qty - {CUBE}.inqty) / NULLIF({CUBE}.qty, 0)) * 
          GREATEST(0, DATE_DIFF(CURRENT_DATE(), CAST({CUBE}.delivery_date AS DATE), DAY))
        type: sum
